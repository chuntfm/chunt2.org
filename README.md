# chunt2.org

> [!WARNING]
> This is not a functional backend yet! Many things are still under development and may change at any time and not work as expected.

This is the backend for chunt.org based on [Kirby 4](https://getkirby.com/) and `kirby-headless-starter`. For information on how to retrieve data via (one of) the API(s), please see the [kirby-headless-starter repository by johannschopplich](https://github.com/johannschopplich/kirby-headless-starter).

To install the project, please refer to the [Setup](#setup) section. For the pecularities of the `kirby-headless-starter` setup, please see [Usage](#usage). ChuntFM-specific information is covered in the next section.

## Overview of the backend repository

To get an idea of how Kirby works, please refer to the [Kirby documentation](https://getkirby.com/docs/guide) and the [Kirby basics playlist on YouTube](https://www.youtube.com/playlist?list=PLTep5U-3mg9EfgnQ08XDRs4vSOmhw2JWz).

### Folder structure

The folder structure is largely copied from `kirby-headless-starter` and therefore slightly different from the default Kirby setup. The most important folders are:

- `public/` contains the publicly accessible files, including the `index.php` and the `.htaccess` file.
- `site/` contains Kirby-specific files, including the `config`, `blueprints`, `models`, and `templates`, `plugins`. I.e., the `site` folder contains all the logic of the backend.
- `storage/` contains content generated by Kirby, such as cache files, logs, and sessions and the users.
  - `content/` contains the content files of the Kirby pages.
  - `accounts/` contains the user accounts. Do not commit this folder to the repository.
  - `cache/` contains the cache files. Do not commit this folder to the repository.
  - `sessions/` contains the session files. Do not commit this folder to the repository.
  - `logs/` contains the log files. Do not commit this folder to the repository.

### Templates (`site/templates/`)

Template control what information is returned by the `headless` plugin API. The templates are located in the `site/templates` folder. The templates are written in PHP and are used to render the content of the Kirby pages. For now, default templates are set upin a way that should cover most use cases. If you require an additional template, create a new file with the corresponding name of the page blueprint in the `site/templates` folder.

### Models (`site/models/`)

The `event` and `schedule` models provide additional methods and custom properties to the Kirby pages. The models are located in the `site/models` folder. The models are written in PHP and are used to extend the default Kirby page object. If you require additional methods or properties, create a new file with the corresponding name of the page blueprint in the `site/models` folder.

- `schedule.php` read ins a `schedule.json` (which can be defined in the `site/config/config.php` or the `.env`) and creates subpages for each event. If an event has additional information that has been created in Kirby, the event page will be created with the additional information.
- `event.php` provides additional methods and properties to the event page.

### Plugins (`site/plugins/`)

Plugins are a way to override or extend the default behavior of Kirby. The plugins are located in the `site/plugins` folder. Currently, the following custom ChuntFM plugins are in use:

- `chuntfm/schedule-search` overrides the default search behavior of Kirby for SchedulePage event. Specifically, it excludes the event key from the searched subpages keys of the Schedule. The default Kirby search chokes on it because it's an array.
- `chuntfm/series-events` provides the logistics to associate events with series and the other way around and display them in the Panel. For example, it makes sure only event creators can edit their events.

## Prerequisites

- PHP 8.1+

## Setup

### Composer

Kirby-related dependencies are managed via [Composer](https://getcomposer.org) and located in the `vendor` directory. To install them, run:

```bash
composer install
```

### Environment Variables

Duplicate the [`.env.development.example`](.env.development.example) as `.env`:

```bash
cp .env.development.example .env
```

Optionally, adapt its values.

> [!NOTE]
> Make sure to set the correct requesting origin instead of the wildcard `KIRBY_HEADLESS_ALLOW_ORIGIN=*` for your deployment.

## Usage

### KirbyQL

> ðŸ“– [See documentation in `kirby-headless` plugin](https://github.com/johannschopplich/kirby-headless#kirbyql)

### Private vs. Public API

It's recommended to secure your API with a token. To do so, set the environment variable `KIRBY_HEADLESS_API_TOKEN` to a token string of your choice.

You will then have to provide the HTTP header `Authentication: Bearer ${token}` with each request.

> [!WARNING]
> Without a token your page content will be publicly accessible to everyone.

> [!NOTE]
> The internal `/api/kql` route will always enforce bearer authentication, unless you explicitly disable it in your config (see below).


### Panel Settings

#### Preview URL to the Frontend

With the headless approach, the default preview link from the Kirby Panel won't make much sense, since it will point to the backend API itself. Thus, we have to overwrite it utilizing a custom page method in your site/page blueprints:

```yaml
options:
  # Or `site.frontendUrl` for the `site.yml`
  preview: "{{ page.frontendUrl }}"
```

Set your frontend URL in your `.env`:

```ini
KIRBY_HEADLESS_FRONTEND_URL=https://example.com
```

If left empty, the preview button will be disabled.

#### Redirect to the Panel

Editors visiting the headless Kirby site may not want to see any API response, but use the Panel solely. To let them automatically be redirected to the Panel, set the following option in your Kirby configuration:

```php
# /site/config/config.php
return [
    'headless' => [
        'panel' => [
            'redirect' => false
        ]
    ]
];
```

### Deployment

> [!NOTE]
> See [ploi-deploy.sh](./scripts/ploi-deploy.sh) for exemplary deployment instructions.
>
> Some hosting environments require uncommenting `RewriteBase /` in [`.htaccess`](./public/.htaccess) to make site links work.
